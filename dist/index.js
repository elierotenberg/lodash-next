"use strict";

require("6to5/polyfill");
var Promise = require("bluebird");
var _ = require("lodash");
var co = require("co");
var sha256 = require("sha256");
var jsonpatch = require("fast-json-patch");

_.mixin({
  scope: function (fn, ctx) {
    return function () {
      fn.apply(ctx, arguments);
    };
  },

  scopeAll: function (fn, ctx, methods) {
    methods.each(function (method) {
      return ctx[method] = _.scope(ctx[method], ctx);
    });
  },

  abstract: function () {
    throw new Error("This method is abstract and should be extended.");
  },

  dev: function (fn) {
    if (process.env.NODE_ENV === "development") {
      return fn();
    }
  },

  prod: function (fn) {
    if (process.env.NODE_ENV === "production") {
      return fn();
    }
  },

  isServer: function () {
    return typeof window === "undefined";
  },

  isClient: function () {
    return !_.isServer();
  },

  Promise: Promise,

  co: co,

  copromise: function (gen, ctx) {
    ctx = ctx || this;
    return new Promise(function (resolve, reject) {
      return co(gen).call(ctx, function (err, res) {
        return err ? reject(err) : resolve(res);
      });
    });
  },

  deco: function (gen, done, ctx) {
    ctx = ctx || this;
    _.co(gen).call(ctx, done);
  },

  sha256: sha256,

  /* jshint ignore:start */
  adler32: function (data) {
    var a = 1;
    var b = 0;
    var MOD = 65521;
    for (var i = 0; i < data.length; i++) {
      a = (a + data.charCodeAt(i)) % MOD;
      b = (b + a) % MOD;
    }
    return a | (b << 16);
  },
  /* jshint ignore:end */

  hash: function (data) {
    if (_.isObject(data)) {
      return _.hash(JSON.stringify(data));
    }
    return _.adler32(data);
  },

  secureHash: function (data) {
    if (_.isObject(data)) {
      return _.secureHash(JSON.stringify(data));
    }
    return _.sha256(data);
  },

  diff: function (prev, next) {
    return jsonpatch.compare(prev, next);
  },

  patch: function (prev, diff) {
    return jsonpatch.apply(prev, diff);
  },

  base64Encode: function (s) {
    return new Buffer(s).toString("base64");
  },

  base64Decode: function (s) {
    return new Buffer(s, "base64").toString("utf-8");
  },

  guid: function (prefix) {
    var s4 = function () {
      return Math.floor((1 + Math.random()) * 65536).toString(16).substring(1);
    };
    prefix = prefix || "";
    return "" + prefix + "" + s4() + "" + s4() + "-" + s4() + "-" + s4() + "-" + s4() + "-" + s4() + "" + s4() + "" + s4();
  },

  breakpoint: function () {
    /*jshint ignore:start*/
    debugger;
    /*jshint ignore:end*/
  },

  rethrow: function (err, desc) {
    if (err) {
      if (desc) {
        err = _.extendError(err, desc);
      }
      throw err;
    }
  },

  extendError: function (err, desc) {
    err.message = "" + desc + ": " + err.message;
    return err;
  },

  record: function (key, val) {
    return (function (_ref) {
      _ref[key] = val;
      return _ref;
    })({});
  },

  sleep: function (delay) {
    return Promise.delay(delay);
  } });

module.exports = _;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImc6L21pc2MvbG9kYXNoLW5leHQvc3JjL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3pCLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNsQyxJQUFNLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDNUIsSUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3pCLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNqQyxJQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQzs7QUFFN0MsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUNOLE9BQUssRUFBQSxVQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUU7QUFDYixXQUFPLFlBQVc7QUFDaEIsUUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLENBQUM7S0FDMUIsQ0FBQztHQUNIOztBQUVELFVBQVEsRUFBQSxVQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFO0FBQ3pCLFdBQU8sQ0FBQyxJQUFJLENBQUMsVUFBQyxNQUFNO2FBQUssR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsQ0FBQztLQUFBLENBQUMsQ0FBQztHQUNuRTs7QUFFRCxVQUFRLEVBQUEsWUFBRztBQUNULFVBQU0sSUFBSSxLQUFLLENBQUMsaURBQWlELENBQUMsQ0FBQztHQUNwRTs7QUFFRCxLQUFHLEVBQUEsVUFBQyxFQUFFLEVBQUU7QUFDTixRQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLGFBQWEsRUFBRTtBQUN6QyxhQUFPLEVBQUUsRUFBRSxDQUFDO0tBQ2I7R0FDRjs7QUFFRCxNQUFJLEVBQUEsVUFBQyxFQUFF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QUFBLFVBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRTtBQUNmO1dBQVUsR0FBRyxJQUFHLEdBQUc7O09BQVosRUFBYyxFQUFDO0dBQ3ZCOztBQUVELE9BQUssRUFBQSxVQUFDLEtBQUssRUFBRTtBQUNYLFdBQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztHQUM3QixFQUVGLENBQUMsQ0FBQzs7QUFFSCxNQUFNLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbInJlcXVpcmUoJzZ0bzUvcG9seWZpbGwnKTtcbnZhciBQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcclxuY29uc3QgY28gPSByZXF1aXJlKCdjbycpO1xyXG5jb25zdCBzaGEyNTYgPSByZXF1aXJlKCdzaGEyNTYnKTtcclxuY29uc3QganNvbnBhdGNoID0gcmVxdWlyZSgnZmFzdC1qc29uLXBhdGNoJyk7XHJcblxyXG5fLm1peGluKHtcclxuICBzY29wZShmbiwgY3R4KSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XHJcbiAgICAgIGZuLmFwcGx5KGN0eCwgYXJndW1lbnRzKTtcclxuICAgIH07XHJcbiAgfSxcclxuXHJcbiAgc2NvcGVBbGwoZm4sIGN0eCwgbWV0aG9kcykge1xyXG4gICAgbWV0aG9kcy5lYWNoKChtZXRob2QpID0+IGN0eFttZXRob2RdID0gXy5zY29wZShjdHhbbWV0aG9kXSwgY3R4KSk7XHJcbiAgfSxcclxuXHJcbiAgYWJzdHJhY3QoKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoaXMgbWV0aG9kIGlzIGFic3RyYWN0IGFuZCBzaG91bGQgYmUgZXh0ZW5kZWQuJyk7XHJcbiAgfSxcclxuXHJcbiAgZGV2KGZuKSB7XHJcbiAgICBpZihwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ2RldmVsb3BtZW50Jykge1xyXG4gICAgICByZXR1cm4gZm4oKTtcclxuICAgIH1cclxuICB9LFxyXG5cclxuICBwcm9kKGZuKSB7XHJcbiAgICBpZihwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSB7XHJcbiAgICAgIHJldHVybiBmbigpO1xyXG4gICAgfVxyXG4gIH0sXHJcblxyXG4gIGlzU2VydmVyKCkge1xyXG4gICAgcmV0dXJuIHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnO1xyXG4gIH0sXHJcblxyXG4gIGlzQ2xpZW50KCkge1xyXG4gICAgcmV0dXJuICFfLmlzU2VydmVyKCk7XHJcbiAgfSxcclxuXHJcbiAgUHJvbWlzZTogUHJvbWlzZSxcclxuXHJcbiAgY286IGNvLFxyXG5cclxuICBjb3Byb21pc2UoZ2VuLCBjdHgpIHtcclxuICAgIGN0eCA9IGN0eCB8fCB0aGlzO1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+XHJcbiAgICAgIGNvKGdlbikuY2FsbChjdHgsIChlcnIsIHJlcykgPT4gZXJyID8gcmVqZWN0KGVycikgOiByZXNvbHZlKHJlcykpXHJcbiAgICApO1xyXG4gIH0sXHJcblxyXG4gIGRlY28oZ2VuLCBkb25lLCBjdHgpIHtcclxuICAgIGN0eCA9IGN0eCB8fCB0aGlzO1xyXG4gICAgXy5jbyhnZW4pLmNhbGwoY3R4LCBkb25lKTtcclxuICB9LFxyXG5cclxuICBzaGEyNTY6IHNoYTI1NixcclxuXHJcbiAgLyoganNoaW50IGlnbm9yZTpzdGFydCAqL1xyXG4gIGFkbGVyMzIoZGF0YSkge1xyXG4gICAgbGV0IGEgPSAxO1xyXG4gICAgbGV0IGIgPSAwO1xyXG4gICAgdmFyIE1PRCA9IDY1NTIxO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGEgPSAoYSArIGRhdGEuY2hhckNvZGVBdChpKSkgJSBNT0Q7XHJcbiAgICAgIGIgPSAoYiArIGEpICUgTU9EO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGEgfCAoYiA8PCAxNik7XHJcbiAgfSxcclxuICAvKiBqc2hpbnQgaWdub3JlOmVuZCAqL1xyXG5cclxuICBoYXNoKGRhdGEpIHtcclxuICAgIGlmKF8uaXNPYmplY3QoZGF0YSkpIHtcclxuICAgICAgcmV0dXJuIF8uaGFzaChKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gXy5hZGxlcjMyKGRhdGEpO1xyXG4gIH0sXHJcblxyXG4gIHNlY3VyZUhhc2goZGF0YSkge1xyXG4gICAgaWYoXy5pc09iamVjdChkYXRhKSkge1xyXG4gICAgICByZXR1cm4gXy5zZWN1cmVIYXNoKEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcclxuICAgIH1cclxuICAgIHJldHVybiBfLnNoYTI1NihkYXRhKTtcclxuICB9LFxyXG5cclxuICBkaWZmKHByZXYsIG5leHQpIHtcclxuICAgIHJldHVybiBqc29ucGF0Y2guY29tcGFyZShwcmV2LCBuZXh0KTtcclxuICB9LFxyXG5cclxuICBwYXRjaChwcmV2LCBkaWZmKSB7XHJcbiAgICByZXR1cm4ganNvbnBhdGNoLmFwcGx5KHByZXYsIGRpZmYpO1xyXG4gIH0sXHJcblxyXG4gIGJhc2U2NEVuY29kZShzKSB7XHJcbiAgICByZXR1cm4gbmV3IEJ1ZmZlcihzKS50b1N0cmluZygnYmFzZTY0Jyk7XHJcbiAgfSxcclxuXHJcbiAgYmFzZTY0RGVjb2RlKHMpIHtcclxuICAgIHJldHVybiBuZXcgQnVmZmVyKHMsICdiYXNlNjQnKS50b1N0cmluZygndXRmLTgnKTtcclxuICB9LFxyXG5cclxuICBndWlkKHByZWZpeCkge1xyXG4gICAgdmFyIHM0ID0gKCkgPT4gTWF0aC5mbG9vcigoMSArIE1hdGgucmFuZG9tKCkpICogMHgxMDAwMClcclxuICAgIC50b1N0cmluZygxNilcclxuICAgIC5zdWJzdHJpbmcoMSk7XHJcbiAgICBwcmVmaXggPSBwcmVmaXggfHwgJyc7XHJcbiAgICByZXR1cm4gYCR7cHJlZml4fSR7czQoKX0ke3M0KCl9LSR7czQoKX0tJHtzNCgpfS0ke3M0KCl9LSR7czQoKX0ke3M0KCl9JHtzNCgpfWA7XHJcbiAgfSxcclxuXHJcbiAgYnJlYWtwb2ludCgpIHtcclxuICAgIC8qanNoaW50IGlnbm9yZTpzdGFydCovXHJcbiAgICBkZWJ1Z2dlcjtcclxuICAgIC8qanNoaW50IGlnbm9yZTplbmQqL1xyXG4gIH0sXHJcblxyXG4gIHJldGhyb3coZXJyLCBkZXNjKSB7XHJcbiAgICBpZihlcnIpIHtcclxuICAgICAgaWYoZGVzYykge1xyXG4gICAgICAgIGVyciA9IF8uZXh0ZW5kRXJyb3IoZXJyLCBkZXNjKTtcclxuICAgICAgfVxyXG4gICAgICB0aHJvdyBlcnI7XHJcbiAgICB9XHJcbiAgfSxcclxuXHJcbiAgZXh0ZW5kRXJyb3IoZXJyLCBkZXNjKSB7XHJcbiAgICBlcnIubWVzc2FnZSA9IGAke2Rlc2N9OiAke2Vyci5tZXNzYWdlfWA7XHJcbiAgICByZXR1cm4gZXJyO1xyXG4gIH0sXHJcblxyXG4gIHJlY29yZChrZXksIHZhbCkge1xyXG4gICAgcmV0dXJuIHsgW2tleV06IHZhbCB9O1xyXG4gIH0sXHJcblxyXG4gIHNsZWVwKGRlbGF5KSB7XHJcbiAgICByZXR1cm4gUHJvbWlzZS5kZWxheShkZWxheSk7XHJcbiAgfSxcclxuXHJcbn0pO1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBfO1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=